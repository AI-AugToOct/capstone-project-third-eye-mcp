# üßø Third Eye MCP

> Overseer mode only. Third Eye never authors deliverables‚Äîit evaluates, enforces, and approves the work produced by your host agents.

## 1. What‚Äôs Inside

| Component | Description |
| --- | --- |
| `src/third_eye/api/server.py` | FastAPI service that manages sessions, settings, and Eye orchestration. |
| `apps/overseer` | Truth Monitor UI (session timeline, Eye cards, evidence lens, exports). |
| `apps/control-plane` | Admin console for API keys, profiles, provider selection, and budgets. |
| `src/third_eye/eyes/*` | Eye implementations (Sharingan ‚Üí Byakugan) with strict JSON envelopes. |
| `src/third_eye/core/settings.py` | Session/profile/system precedence resolver + provider snapshot. |
| `tests/` | Extensive pytest suite covering Eyes, APIs, admin workflows, and resilience logic. |

Third Eye augments existing agents: it asks clarifying questions, checks plans, enforces phase gates, and only issues approvals when every Eye is satisfied.

## 2. Quickstart

```bash
# 1. Install runtime deps (Python ‚â•3.11, uv, Node 18+, Docker if you want Postgres/Redis locally)
uv pip install -e .[test]

# 2. Start Postgres + Redis (recommended)
docker compose up postgres redis -d

# 3. Apply database migrations (Postgres path)
alembic upgrade head

# 4. Copy env template and add secrets
cp .env.example .env
# set GROQ_API_KEY / OPENROUTER_API_KEY (or switch to offline provider)

# 5. Run the API
yuvicorn third_eye.api.server:app --reload

# 6. Launch the Truth Monitor UI
cd apps/overseer
pnpm install
pnpm dev
```

API docs (OpenAPI JSON) are generated by FastAPI at `/openapi.json`. See [API_REFERENCE.md](docs/API_REFERENCE.md) for human-readable summaries and curl samples.

## 3. Creating & Monitoring Sessions

1. `POST /session` returns `{"session_id", "portal_url"}` and broadcasts initial settings over websockets.
2. IDE or MCP clients interact with Eyes by calling the endpoints in [API_REFERENCE.md](docs/API_REFERENCE.md#session-endpoints).
3. The overseer portal connects to `/ws/pipeline/{session_id}` to stream Eye updates. `tests/test_admin_api.py::test_admin_key_accesses_sessions_and_pipeline` verifies the end-to-end handshake.
4. Adjust live strictness via `PUT /session/{id}/settings` (see [Admin Guide](docs/ADMIN_GUIDE.md) for profile presets and overrides).

## 4. Eye Contracts at a Glance

- **Sharingan** ‚Äî ambiguity radar, enforces clarifying questions (`tests/test_eye_settings.py::test_sharingan_respects_threshold`).
- **Prompt Helper** ‚Äî structured ROLE/TASK/CONTEXT/REQUIREMENTS/OUTPUT prompt.
- **J≈çgan** ‚Äî token/intent guardian.
- **Rinnegan** ‚Äî plan schema, review, final approval (rollback policy enforced via session settings).
- **Mangeky≈ç** ‚Äî scaffold/impl/tests/docs strictness driven by `mangekyo` level.
- **Tenseigan** ‚Äî citation verification with cutoff derived from session settings.
- **Byakugan** ‚Äî consistency score vs session memory.

Each Eye returns the standard envelope (`tag`, `ok`, `code`, `md`, `data`, `next`) defined in `src/third_eye/constants.py` and exercised by `tests/test_eye_settings.py`.

## 5. Providers

The provider registry (`src/third_eye/providers/factory.py`) selects between:
- Groq (default)
- OpenRouter
- Offline (vLLM/llama.cpp) ‚Äî see [Admin Guide](docs/ADMIN_GUIDE.md#switching-providers)

`tests/test_llm_resilience.py` ensures retry backoff and fallback logic work as expected.

## 6. Security & Guardrails

- API keys are required for all non-health endpoints. Rate limits and budget quotas enforced in `enforce_request_policies()` (`tests/test_api.py::test_api_rate_limit`).
- Admin endpoints are RBAC-gated and emit audit events (`tests/test_admin_api.py::test_admin_create_list_and_revoke`).
- Markdown inputs are sanitised server side; Eyes refuse responses missing mandatory reasoning sections.
- Websocket sessions record connect/disconnect audit logs and stream settings snapshots for observability.

More details in [Phase 5 status](end_to_end_clean_ship_plan.md#phase-5--Ô∏è-security--perf-hardening).

## 7. Docs & Runbooks

| Doc | Summary |
| --- | --- |
| [USER_GUIDE.md](USER_GUIDE.md) | Truth Monitor walkthrough (sessions, Eye cards, exports). |
| [ADMIN_GUIDE.md](docs/ADMIN_GUIDE.md) | Key lifecycle, profiles, provider switching, budgets, observability. |
| [API_REFERENCE.md](docs/API_REFERENCE.md) | REST + Websocket contract with curl examples. |
| [DEPLOYMENT_ALIYUN.md](docs/DEPLOYMENT_ALIYUN.md) | ACK/RDS/Redis/Log Service deployment steps with TLS + monitoring. |
| [TRUE_VISION.md](TRUE_VISION.md) | Canonical Overseer vision. |

## 8. Contributing

1. Fork, branch from `release/clean-ship`.
2. Ensure `pytest` passes.
3. Update relevant docs + `end_to_end_clean_ship_plan.md` with evidence links.
4. Submit PR with context + links to recordings/screenshots when closing plan items.

---

Need help? Ping the Overseer maintainers or open an issue with reproduction steps plus the failing Eye logs.
